<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›²å‘æŠ½ç­¾åº”ç”¨ - å‡çº§ç‰ˆ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin-top: 50px; background-color: #f4f4f9; color: #333; }
        .container { background: white; max-width: 400px; margin: 0 auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { padding: 10px; font-size: 16px; width: 80%; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 6px; transition: 0.3s; margin: 5px; }
        button:hover { background-color: #0056b3; }
        .hidden { display: none !important; }
        #my-role { font-size: 40px; font-weight: bold; color: #d9534f; margin: 20px 0; }
        
        /* æŒ‰é’®ç‰¹å®šé¢œè‰² */
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-warning:hover { background-color: #e0a800; }
        
        .action-buttons { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h2>âš”ï¸ ç»„é˜ŸæŠ½ç­¾</h2>
        <input type="text" id="room-id" placeholder="è¾“å…¥æˆ¿é—´å· (å¦‚ 888)" autocomplete="off">
        <input type="text" id="player-name" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" autocomplete="off" maxlength="10">
        <br>
        <button onclick="joinRoom()">è¿›å…¥æˆ¿é—´</button>
    </div>

    <div id="room-screen" class="hidden">
        <h2>æˆ¿é—´: <span id="display-room"></span></h2>
        <p>ä½ çš„èº«ä»½: <strong id="my-id"></strong> <span id="host-badge" style="color:red; display:none;">(ğŸ‘‘ æˆ¿ä¸»)</span></p>
        <hr>
        <p id="host-info"></p>
        <p id="player-list"></p>
        
        <p id="waiting-text" class="hidden" style="color: #666;">ç­‰å¾…æˆ¿ä¸»å‘ç‰Œ...</p>
        
        <div class="action-buttons">
            <button id="start-btn" class="btn-success hidden" onclick="sendAction('start')">å¼€å§‹å‘ç‰Œï¼</button>
            <button id="destroy-btn" class="btn-danger hidden" onclick="sendAction('destroy')">è§£æ•£æˆ¿é—´</button>
            <button id="leave-btn" class="btn-warning" onclick="sendAction('leave')">é€€å‡ºæˆ¿é—´</button>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h2>ä½ çš„è§’è‰²æ˜¯</h2>
        <div id="my-role"></div>
        <p style="color: #666;">å˜˜ï¼Œåªæœ‰ä½ èƒ½çœ‹åˆ°ï¼</p>
        <button class="btn-warning" style="margin-top:20px" onclick="backToHome()">è¿”å›é¦–é¡µ</button>
    </div>
</div>

<script>
    let ws = null;
    let heartbeatInterval = null; // ã€æ–°å¢ã€‘ç”¨æ¥å­˜æ”¾å®šæ—¶å™¨

    function joinRoom() {
        const roomId = document.getElementById('room-id').value.trim();
        const playerName = document.getElementById('player-name').value.trim();
        
        if (!roomId || !playerName) return alert("æˆ¿é—´å·å’Œæ˜µç§°éƒ½ä¸èƒ½ä¸ºç©ºï¼");

        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws/${roomId}?client_id=${encodeURIComponent(playerName)}`;
        
        ws = new WebSocket(wsUrl);

        // ã€æ–°å¢ã€‘è¿æ¥æ‰“å¼€åï¼Œç«‹åˆ»å¯åŠ¨å¿ƒè·³
        ws.onopen = function() {
            console.log("è¿æ¥æˆåŠŸï¼Œå¯åŠ¨å¿ƒè·³");
            // æ¯ 30 ç§’ï¼ˆ30000æ¯«ç§’ï¼‰ç»™æœåŠ¡å™¨å‘ä¸€æ¡æ¯«æ— æ„ä¹‰çš„ "ping" æ¶ˆæ¯ï¼Œç”¨æ¥ç»­å‘½
            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({action: "ping"}));
                }
            }, 30000);
        };

        ws.onmessage = function(event) {
            // ...(è¿™éƒ¨åˆ†å’ŒåŸæ¥ä¸€æ ·ï¼Œä¿æŒä¸å˜)...
            const data = JSON.parse(event.data);

            if (data.type === "welcome") {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('room-screen').classList.remove('hidden');
                document.getElementById('display-room').innerText = roomId;
                document.getElementById('my-id').innerText = data.player_id;
                
                updateHostUI(data.is_host);
            } 
            else if (data.type === "update") {
                document.getElementById('host-info').innerText = "ğŸ‘‘ æˆ¿ä¸»: " + data.host;
                document.getElementById('player-list').innerText = `ğŸ‘¥ ç©å®¶ (${data.players.length}/5): ` + data.players.join(", ");
            } 
            else if (data.type === "result") {
                document.getElementById('room-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                document.getElementById('my-role').innerText = data.role;
            } 
            else if (data.type === "become_host") {
                alert("åŸæˆ¿ä¸»å·²é€€å‡ºï¼Œä½ æˆä¸ºäº†æ–°æˆ¿ä¸»ï¼");
                updateHostUI(true);
            }
            else if (data.type === "destroyed") {
                alert("æˆ¿ä¸»è§£æ•£äº†æˆ¿é—´ï¼");
                backToHome();
            }
            else if (data.type === "error") {
                alert(data.msg);
                if (data.msg.includes("å·²æ»¡") || data.msg.includes("è¢«å ç”¨")) {
                    backToHome(); // å‡ºé”™é€€å›é¦–é¡µ
                }
            }
        };

        ws.onclose = function() {
            console.log("è¿æ¥å·²æ–­å¼€");
            // ã€æ–°å¢ã€‘æ–­å¼€è¿æ¥æ—¶ï¼Œåœæ­¢å¿ƒè·³å®šæ—¶å™¨
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        };
    }

    function sendAction(actionType) {
        if(ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({action: actionType}));
            if(actionType === 'leave') {
                backToHome();
            }
        }
    }

    function updateHostUI(isHost) {
        if (isHost) {
            document.getElementById('host-badge').style.display = "inline";
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('destroy-btn').classList.remove('hidden');
            document.getElementById('waiting-text').classList.add('hidden');
        } else {
            document.getElementById('host-badge').style.display = "none";
            document.getElementById('start-btn').classList.add('hidden');
            document.getElementById('destroy-btn').classList.add('hidden');
            document.getElementById('waiting-text').classList.remove('hidden');
        }
    }

    function backToHome() {
            if (ws) {
                ws.close();
                ws = null;
            }
            // ã€æ–°å¢ã€‘ç”¨æˆ·ä¸»åŠ¨é€€å‡ºæ—¶ï¼Œä¹Ÿè¦åœæ‰å¿ƒè·³å®šæ—¶å™¨
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            // é‡ç½®ç•Œé¢
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('room-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
        }
</script>

</body>
</html>

